<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Check React - Vecino Activo</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; padding: 20px; background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); 
            min-height: 100vh;
        }
        .container { 
            max-width: 900px; margin: 0 auto; background: white; padding: 40px; 
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
        }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .check-item { 
            margin: 15px 0; padding: 15px; border-radius: 10px; 
            border-left: 5px solid #007bff; background: #f8f9fa;
        }
        .check-item.success { border-left-color: #28a745; background: #d4edda; }
        .check-item.error { border-left-color: #dc3545; background: #f8d7da; }
        .check-item.warning { border-left-color: #ffc107; background: #fff3cd; }
        .buttons { 
            display: flex; flex-wrap: wrap; gap: 10px; margin: 30px 0; 
            justify-content: center;
        }
        button { 
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); 
            color: white; padding: 12px 24px; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: 600; transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        .links { 
            text-align: center; margin-top: 30px; padding: 20px; 
            background: #f8f9fa; border-radius: 10px;
        }
        .links a { 
            display: inline-block; margin: 5px 10px; padding: 10px 20px; 
            background: #28a745; color: white; text-decoration: none; 
            border-radius: 6px; transition: background 0.3s;
        }
        .links a:hover { background: #1e7e34; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Check React App</h1>
        
        <div id="checks"></div>
        
        <div class="buttons">
            <button onclick="runChecks()">ğŸ”„ Ejecutar Verificaciones</button>
            <button onclick="testManualLogin()">ğŸ§ª Login Manual</button>
            <button onclick="clearStorage()">ğŸ—‘ï¸ Limpiar Storage</button>
            <button onclick="checkMainApp()">ğŸ  Verificar App Principal</button>
        </div>
        
        <div class="links">
            <a href="/">ğŸ” Debug Login</a>
            <a href="http://localhost:3005" target="_blank">ğŸ  App Principal</a>
            <a href="javascript:location.reload()">ğŸ”„ Recargar</a>
        </div>
    </div>

    <script>
        function addCheck(message, type = 'info', details = '') {
            const checksDiv = document.getElementById('checks');
            const checkDiv = document.createElement('div');
            checkDiv.className = `check-item ${type}`;
            checkDiv.innerHTML = `
                <strong>${message}</strong>
                ${details ? `<div style="margin-top: 8px; font-size: 14px; opacity: 0.8;">${details}</div>` : ''}
            `;
            checksDiv.appendChild(checkDiv);
        }
        
        function clearChecks() {
            document.getElementById('checks').innerHTML = '';
        }
        
        function runChecks() {
            clearChecks();
            addCheck('ğŸ”„ Iniciando verificaciones del sistema...', 'info');
            
            // Check 1: localStorage
            try {
                localStorage.setItem('test-check', 'test');
                localStorage.removeItem('test-check');
                addCheck('âœ… localStorage funciona correctamente', 'success');
                
                const authSession = localStorage.getItem('vecino-activo-auth');
                if (authSession) {
                    const session = JSON.parse(authSession);
                    addCheck('âœ… SesiÃ³n de usuario encontrada', 'success', `Usuario: ${session.user?.name || 'Desconocido'}`);
                } else {
                    addCheck('â„¹ï¸ No hay sesiÃ³n activa', 'info', 'Usuario no estÃ¡ logueado');
                }
            } catch (e) {
                addCheck('âŒ localStorage no funciona', 'error', e.message);
            }
            
            // Check 2: Conectividad
            fetch('http://localhost:3005/')
                .then(response => {
                    addCheck(`âœ… Conectividad a app principal OK`, 'success', `Status: ${response.status}`);
                    return response.text();
                })
                .then(html => {
                    if (html.includes('Vecino Activo') || html.includes('root')) {
                        addCheck('âœ… App principal carga correctamente', 'success');
                    } else {
                        addCheck('âš ï¸ App principal responde pero contenido inesperado', 'warning');
                    }
                })
                .catch(error => {
                    addCheck('âŒ No se puede conectar a app principal', 'error', error.message);
                });
            
            // Check 3: Supabase
            const supabaseUrl = 'https://supabase.vecinoactivo.cl';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE';
            
            fetch(`${supabaseUrl}/rest/v1/users?select=count&limit=1`, {
                headers: {
                    'apikey': supabaseKey,
                    'Authorization': `Bearer ${supabaseKey}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    addCheck('âœ… ConexiÃ³n a Supabase OK', 'success', 'Base de datos accesible');
                } else {
                    addCheck(`âŒ Error en Supabase: ${response.status}`, 'error');
                }
            })
            .catch(error => {
                addCheck('âŒ No se puede conectar a Supabase', 'error', error.message);
            });
            
            // Check 4: JavaScript bÃ¡sico
            try {
                const testAsync = async () => {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    return 'OK';
                };
                
                testAsync().then(result => {
                    addCheck('âœ… JavaScript async/await funciona', 'success');
                });
                
                addCheck('âœ… JavaScript bÃ¡sico funciona', 'success');
            } catch (e) {
                addCheck('âŒ Error en JavaScript bÃ¡sico', 'error', e.message);
            }
        }
        
        function testManualLogin() {
            clearChecks();
            addCheck('ğŸ§ª Iniciando login manual...', 'info');
            
            const email = 'admin@vecinoactivo.cl';
            const password = 'admin123';
            
            // Verificar credenciales
            if (email === 'admin@vecinoactivo.cl' && password === 'admin123') {
                addCheck('âœ… Credenciales correctas', 'success');
                
                // Test Supabase
                const supabaseUrl = 'https://supabase.vecinoactivo.cl';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE';
                
                fetch(`${supabaseUrl}/rest/v1/users?email=eq.${email}&select=*`, {
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        addCheck('âœ… ConexiÃ³n a Supabase OK', 'success');
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                })
                .then(users => {
                    if (users && users.length > 0) {
                        addCheck(`âœ… Usuario encontrado: ${users[0].name}`, 'success');
                        
                        // Crear sesiÃ³n
                        const session = {
                            user: users[0],
                            access_token: 'simple_admin_token',
                            expires_at: Date.now() + (24 * 60 * 60 * 1000),
                            simple_auth: true
                        };
                        
                        localStorage.setItem('vecino-activo-auth', JSON.stringify(session));
                        addCheck('âœ… SesiÃ³n creada y guardada', 'success');
                        
                        setTimeout(() => {
                            const goToApp = confirm('ğŸ‰ Login manual exitoso! Â¿Ir a la aplicaciÃ³n?');
                            if (goToApp) {
                                window.open('http://localhost:3005/app', '_blank');
                            }
                        }, 1000);
                    } else {
                        addCheck('âŒ Usuario no encontrado', 'error');
                    }
                })
                .catch(error => {
                    addCheck(`âŒ Error en Supabase: ${error.message}`, 'error');
                });
            } else {
                addCheck('âŒ Credenciales incorrectas', 'error');
            }
        }
        
        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            addCheck('âœ… Storage limpiado completamente', 'success', 'localStorage y sessionStorage vaciados');
        }
        
        function checkMainApp() {
            clearChecks();
            addCheck('ğŸ” Verificando aplicaciÃ³n principal...', 'info');
            
            // Abrir en nueva ventana para inspeccionar
            const newWindow = window.open('http://localhost:3005', '_blank');
            
            setTimeout(() => {
                addCheck('âœ… AplicaciÃ³n abierta en nueva ventana', 'success', 'Revisa si carga correctamente');
                addCheck('ğŸ’¡ Instrucciones:', 'info', 'En la nueva ventana, abre DevTools (F12) y revisa la consola por errores');
            }, 1000);
        }
        
        // Auto-run checks on load
        window.addEventListener('load', () => {
            setTimeout(runChecks, 500);
        });
        
        // Capture errors
        window.addEventListener('error', (e) => {
            console.error('Error capturado:', e.message);
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Promise rejection:', e.reason);
        });
    </script>
</body>
</html>